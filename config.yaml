# config.yaml
# ===========
# Configuration for eDNA Analysis Pipeline with Enhanced Evaluation

# ============================================================================
# PATHS
# ============================================================================
paths:
  # Raw data
  raw_dir: "dataset/raw"
  
  # Processed data
  processed_dir: "dataset/processed"
  
  # CGR images
  cgr_dir: "dataset/cgr"
  
  # Trained models
  models_dir: "models"
  
  # Embeddings
  embeddings_dir: "dataset/embeddings"
  
  # Clustering results
  clusters_dir: "dataset/clusters"
  
  # Cluster annotations (NEW)
  annotation_dir: "dataset/annotation"
  
  # Evaluation results
  evaluation_dir: "dataset/evaluation"
  
  # Visualizations
  visualization_dir: "dataset/visualization"
  
  # Ground truth taxonomy files (UPDATED: now a list)
  taxonomy_files: 
    - "dataset/ssu_accession_full_lineage.tsv"
    - "dataset/LSU_eukaryote_rRNA_accession_full_lineage.tsv"
    - "dataset/ITS_eukaryote_sequences_accession_full_lineage.tsv"
    - "dataset/16S_ribosomal_RNA_accession_full_lineage.tsv"
    
    # Add more files as needed


# ============================================================================
# CGR TRANSFORMATION
# ============================================================================
cgr:
  # Image size (64x64 or 128x128)
  image_size: 64
  
  # Apply log transformation to frequencies
  log_transform: true


# ============================================================================
# CNN TRAINING
# ============================================================================
training:
  # Embedding dimension
  embedding_dim: 256
  
  # Batch size
  batch_size: 128
  
  # Number of epochs
  num_epochs: 100
  
  # Learning rate
  learning_rate: 0.001
  
  # Device (cuda or cpu)
  device: "cuda"
  
  # Weight decay for regularization
  weight_decay: 0.0001
  
  # Contrastive loss temperature
  temperature: 0.5


# ============================================================================
# CLUSTERING (HDBSCAN)
# ============================================================================
clustering:
  # Minimum cluster size
  min_cluster_size: 3
  
  # Minimum samples
  min_samples: 1
  
  # Cluster selection epsilon
  cluster_selection_epsilon: 0.7
  
  # Distance metric
  metric: "l2"
  
  # Normalize embeddings before clustering
  normalize: true


# ============================================================================
# CLUSTER ANNOTATION (UPDATED FOR LOCAL-ONLY MODE)
# ============================================================================
annotation:
  # Identity thresholds
  identity_threshold_novel: 95.0      # Below this = novel
  identity_threshold_species: 97.0    # Above this = same species
  
  # BLAST settings (UPDATED: now a list of databases)
  use_local_blast: true
  databases: 
      - "./dataset/raw/SSU_eukaryote_rRNA/SSU_eukaryote_rRNA"
      - "./dataset/raw/LSU_eukaryote_rRNA/LSU_eukaryote_rRNA"
      - "./dataset/raw/ITS_eukaryote_sequences/ITS_eukaryote_sequences"
      - "./dataset/raw/16S_ribosomal_RNA/16S_ribosomal_RNA"

  # Add more databases as needed
  
  # Processing options
  max_clusters_to_annotate: null      # null = all clusters, or set a limit
  batch_size: 128                    # Process in batches (null = no batching)
  resume_from_checkpoint: false       # Resume interrupted annotation
  
  # Validation
  min_alignment_length: 100           # Minimum BLAST alignment length
  max_evalue: 0.00001                 # Maximum acceptable e-value

  resources:
  num_workers: 4      # Threads per individual BLAST job
  max_workers: 8      # Number of parallel BLAST jobs

  annotation:
    parallel_blast: true   # Enable parallel execution
    chunk_size: 1000       # Sequences per chunk (tune based on memory)


# ============================================================================
# EVALUATION (ENHANCED)
# ============================================================================
evaluation:
  # Taxonomic levels to evaluate
  taxonomic_levels:
    - genus
    - species
  
  # Novelty detection thresholds
  novelty_confidence_threshold: 0.5
  
  # Cluster purity threshold
  high_purity_threshold: 0.8


# ============================================================================
# VISUALIZATION
# ============================================================================
visualization:
  # Maximum points for UMAP (to avoid memory issues)
  max_umap_points: 10000
  
  # Number of top clusters to display
  top_clusters_display: 20
  
  # Figure DPI
  figure_dpi: 300
  
  # Color palette
  color_palette: "tab20"


# ============================================================================
# PREPROCESSING
# ============================================================================
preprocessing:
  # Minimum sequence length (bp)
  min_length: 100
  
  # Maximum ratio of ambiguous bases
  max_ambiguous_ratio: 0.10


# ============================================================================
# COMPUTATIONAL RESOURCES
# ============================================================================
resources:
  # Number of CPU workers for data loading
  num_workers: 12
  
  # Enable GPU acceleration where available
  use_gpu: true
  
  # Memory map mode for large files
  use_mmap: true


# ============================================================================
# LOGGING
# ============================================================================
logging:
  # Logging level (DEBUG, INFO, WARNING, ERROR)
  level: "INFO"
  
  # Save logs to file
  save_logs: true
  
  # Log directory
  log_dir: "logs"


# ============================================================================
# EXPERIMENTAL FEATURES
# ============================================================================
experimental:
  # Use cuML for GPU-accelerated HDBSCAN
  use_cuml: true
  
  # Enable multi-marker integration
  multi_marker: true
  
  # Use ensemble clustering
  ensemble_clustering: false


# ============================================================================
# NOTES
# ============================================================================
# This configuration now supports:
# 1. MULTIPLE taxonomy TSV files (merged into single lookup table)
# 2. MULTIPLE BLAST databases (searched sequentially, best hit kept)
# 3. 100% LOCAL operation (no Entrez API calls)
# 4. Fast annotation (~0.01s per cluster vs 3-5s with Entrez)
#
# TSV Format Expected:
# accession<TAB>taxid<TAB>species_name<TAB>full_lineage
# Example:
# JF718645.1<TAB>1001139<TAB>Apokeronopsis ovalis<TAB>cellular organisms;Eukaryota;...
#
# BLAST databases should be formatted with makeblastdb and include the base name
# (without .nhr, .nin, .nsq extensions)